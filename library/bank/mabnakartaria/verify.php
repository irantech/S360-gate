<?php
/**
 * This file manage topup-payment to use in websites.
 * At first following variables should be set to use in web services.
 *
 * @author Mojtaba Rahbari <mrahbari@infotech-co.com | mojtaba.rahbari@gmail.com>
 * @copyright &copy; from 2015 Infotech International Co.
 * @version 1.0.0
 * @date 2016/06/01 18:56:11 PM
 */

/**
 * public key generated by mabna co
 */
$__PUBLIC_KEY = "
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCETtzC9pZ+dnQ0z0pXL6pNrkn4vGdbLTf3fhH5
MsVYsFIPuuaUSC9EnbTa8G9p1AIKNsjQaBbzfkvgdu5Tz8qEXZfYQV2bnSCtl/87M7Xn0raAmGTr
jSliTdsxMyJHObzAPkamjHemAxHd9VkwXfZOPAh00ueag+buTAkbzL1MlQIDAQAB
-----END PUBLIC KEY-----
";

/**
 * private key generated by mabna co
 */
$__PRIVATE_KEY = "
-----BEGIN PRIVATE KEY-----
" . trim($__PRIVATE_KEY) . "
-----END PRIVATE KEY-----
";

/**
 * Reference soap address
 */
$__REFRENCE_SOAP = "https://mabna.shaparak.ir/TransactionReference/TransactionReference?wsdl";

/**
 * Include Web Services Toolkit for PHP
 */
$CLIENT = new nusoap_client($__REFRENCE_SOAP, 'wsdl');

/**
 * show the errors
 */
$ERROR = $CLIENT->getError();
//print_r($ERROR);

/**
 * Get key resource to start based on public key
 */
$KEY_RESOURCE = openssl_get_publickey($__PUBLIC_KEY);

/**
 * Digital receipts buy
 */
openssl_public_encrypt($__TRN, $CRYPT_TEXT, $KEY_RESOURCE);
$TRN = base64_encode($CRYPT_TEXT);

/**
 * CRN Crypted
 */
openssl_public_encrypt($__CRN, $CRYPT_TEXT, $KEY_RESOURCE);
$CRN = base64_encode($CRYPT_TEXT);

/**
 * MID Crypted
 */
openssl_public_encrypt($__MID, $CRYPT_TEXT, $KEY_RESOURCE);
$MID = base64_encode($CRYPT_TEXT);

/**
 * Sign data
 */
$SOURCE = $__MID . $__TRN . $__CRN;

$SIGNATURE = '';
$PRIVATE_KEY = openssl_pkey_get_private($__PRIVATE_KEY);
if (!openssl_sign($SOURCE, $SIGNATURE, $PRIVATE_KEY, OPENSSL_ALGO_SHA1)) {
    //echo "OPEN SSL SIGN ERROR";
} else {
    //echo "<BR>" . $SOURCE . "<BR>" . base64_encode($SIGNATURE);        //comment by mojtaba
}

$INPUT_ARRAY = array(
    "SaleConf_req" => array(
        "MID" => $MID,
        "CRN" => $CRN,
        "TRN" => $TRN,
        "SIGNATURE" => base64_encode($SIGNATURE)
    )
);
$WSResult = $CLIENT->call("sendConfirmation", $INPUT_ARRAY);
$ERROR = $CLIENT->getError();

/**
 * Final signature is created
 */
$SIGNATURE = base64_decode($WSResult["return"]["SIGNATURE"]);
$DATA = $WSResult["return"]["RESCODE"] . $WSResult["return"]["REPETETIVE"] . $WSResult["return"]["AMOUNT"] . $WSResult["return"]["DATE"] . $WSResult["return"]["TIME"] . $WSResult["return"]["TRN"] . $WSResult["return"]["STAN"];

/**
 * state whether signature is okay or not
 */
$VERIFY_RESULT = openssl_verify($DATA, $SIGNATURE, $KEY_RESOURCE);
