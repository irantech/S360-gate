<?php
/**
 * This file manage e-payment to use in websites.
 * At first following variables should be set to use in web services.
 *
 * @author Mojtaba Rahbari <mrahbari@infotech-co.com | mojtaba.rahbari@gmail.com>
 * @copyright &copy; from 2015 Infotech International Co.
 * @version 1.0.0
 * @date 2016/06/01 18:56:11 PM
 */

/**
 * public key generated by mabna co
 */
$__PUBLIC_KEY = "
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCETtzC9pZ+dnQ0z0pXL6pNrkn4vGdbLTf3fhH5
MsVYsFIPuuaUSC9EnbTa8G9p1AIKNsjQaBbzfkvgdu5Tz8qEXZfYQV2bnSCtl/87M7Xn0raAmGTr
jSliTdsxMyJHObzAPkamjHemAxHd9VkwXfZOPAh00ueag+buTAkbzL1MlQIDAQAB
-----END PUBLIC KEY-----
";

/**
 * private key generated by mabna co
 */
$__PRIVATE_KEY = "
-----BEGIN PRIVATE KEY-----
" . trim($__PRIVATE_KEY) . "
-----END PRIVATE KEY-----
";

/**
 * proper web service to do payments
 */
$__SOAP = "https://mabna.shaparak.ir/TokenService?wsdl";

/**
 * include Web Services Toolkit for PHP
 */
$CLIENT = new nusoap_client($__SOAP, 'wsdl');

/**
 * show the errors
 */
$ERROR = $CLIENT->getError();
print_r($ERROR);

/**
 * Make a signature temporary
 * Note: each paid has it's own specific signature
 */
$SOURCE = $__AMT . $__CRN . $__MID . $__REFADD . $__TID;

/**
 * get key resource to start based on public key
 */
$KEY_RESOURCE = openssl_get_publickey($__PUBLIC_KEY);
openssl_public_encrypt($__AMT, $CRYPT_TEXT, $KEY_RESOURCE);

/**
 * Amount Crypted
 */
$AMOUNT = base64_encode($CRYPT_TEXT);

/**
 * CRN Crypted
 **/
openssl_public_encrypt($__CRN, $CRYPT_TEXT, $KEY_RESOURCE);
$CRN = base64_encode($CRYPT_TEXT);

/**
 * MID Crypted
 */
openssl_public_encrypt($__MID, $CRYPT_TEXT, $KEY_RESOURCE);
$MID = base64_encode($CRYPT_TEXT);

/**
 * TID Crypted
 */
openssl_public_encrypt($__TID, $CRYPT_TEXT, $KEY_RESOURCE);
$TID = base64_encode($CRYPT_TEXT);

/**
 * Referral addressCrypted
 */
openssl_public_encrypt($__REFADD, $CRYPT_TEXT, $KEY_RESOURCE);
$REFERRAL = base64_encode($CRYPT_TEXT);

/**
 * Sign data and make final signature
 */
$SIGNATURE = '';
$PRIVATE_KEY = openssl_pkey_get_private($__PRIVATE_KEY);
if (!openssl_sign($SOURCE, $SIGNATURE, $PRIVATE_KEY, OPENSSL_ALGO_SHA1)) {
    echo "OPEN SSL SIGN ERROR";
} else {
    //echo base64_encode($SIGNATURE);
}

/**
 * Make proper array of token params
 */
$INPUT_ARRAY = array(
    "Token_param" =>
        array(
            "AMOUNT" => $AMOUNT,
            "CRN" => $CRN,
            "MID" => $MID,
            "REFERALADRESS" => $REFERRAL,
            "SIGNATURE" => base64_encode($SIGNATURE),
            "TID" => $TID,
        )
);
$WS_RESULT = $CLIENT->call("reservation", $INPUT_ARRAY);
$ERROR = $CLIENT->getError();
//print_r($WS_RESULT);

/**
 * Final signature is created
 */
$SIGNATURE = base64_decode($WS_RESULT["return"]["signature"]);

/**
 * State whether signature is okay or not
 */
$VERIFY_RESULT = openssl_verify($WS_RESULT["return"]["token"], $SIGNATURE, $KEY_RESOURCE);

/**
 * Free the key from memory
 **/
openssl_free_key($KEY_RESOURCE);
